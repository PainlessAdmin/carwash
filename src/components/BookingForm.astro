---
const vehicleTypes = [
  { id: 'car', label: 'Car', icon: 'üöó' },
  { id: 'suv', label: 'SUV / Estate', icon: 'üöô' },
  { id: 'van', label: 'Van', icon: 'üöê' },
];

const services = [
  { id: 'wash-wax', label: 'Wash & Wax', price: { car: 10, suv: 15, van: 15 } },
  { id: 'bronze', label: 'Bronze Wash', price: { car: 20, suv: 25, van: 25 } },
  { id: 'silver', label: 'Silver Wash', price: { car: 25, suv: 30, van: 30 } },
  { id: 'wash-polish', label: 'Wash & Polish', price: { car: 40, suv: 50, van: 50 } },
  { id: 'special', label: 'Special Offer', price: { car: 35, suv: 45, van: 45 } },
  { id: 'full-valet', label: 'Full Valet', price: { car: 60, suv: 70, van: 70 } },
];
---

<!-- Booking Modal -->
<div id="booking-modal" class="fixed inset-0 z-[100] hidden">
  <!-- Backdrop -->
  <div class="absolute inset-0 bg-black/60 backdrop-blur-sm" id="booking-backdrop"></div>

  <!-- Modal Content -->
  <div class="absolute inset-0 flex items-center justify-center p-4">
    <div class="bg-white rounded-2xl shadow-2xl w-full max-w-lg relative overflow-hidden">
      <!-- Close Button -->
      <button id="booking-close" class="absolute top-4 right-4 w-10 h-10 bg-gray-100 hover:bg-gray-200 rounded-full flex items-center justify-center z-10 transition-colors">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
        </svg>
      </button>

      <!-- Progress Bar -->
      <div class="h-1 bg-gray-100">
        <div id="progress-bar" class="h-full bg-primary transition-all duration-300" style="width: 16.66%"></div>
      </div>

      <!-- Form Container -->
      <div class="p-8">
        <!-- Step Indicator -->
        <div class="text-center mb-2">
          <span id="step-indicator" class="text-sm text-gray-500">Step 1 of 6</span>
        </div>

        <!-- Steps Container -->
        <div id="steps-container" class="relative min-h-[300px]">

          <!-- Step 1: Vehicle Type -->
          <div class="booking-step" data-step="1">
            <h3 class="text-2xl font-heading font-bold text-gray-900 text-center mb-6">
              What type of vehicle?
            </h3>
            <div class="grid grid-cols-3 gap-4">
              {vehicleTypes.map((vehicle) => (
                <button
                  type="button"
                  class="vehicle-option p-6 border-2 border-gray-200 rounded-xl hover:border-primary hover:bg-primary/5 transition-all text-center group"
                  data-vehicle={vehicle.id}
                >
                  <span class="text-4xl block mb-2">{vehicle.icon}</span>
                  <span class="font-medium text-gray-900 group-hover:text-primary">{vehicle.label}</span>
                </button>
              ))}
            </div>
          </div>

          <!-- Step 2: Service -->
          <div class="booking-step hidden" data-step="2">
            <h3 class="text-2xl font-heading font-bold text-gray-900 text-center mb-6">
              Choose your service
            </h3>
            <div class="space-y-3 max-h-[280px] overflow-y-auto pr-2">
              {services.map((service) => (
                <button
                  type="button"
                  class="service-option w-full p-4 border-2 border-gray-200 rounded-xl hover:border-primary hover:bg-primary/5 transition-all text-left flex justify-between items-center group"
                  data-service={service.id}
                  data-service-label={service.label}
                  data-price-car={service.price.car}
                  data-price-suv={service.price.suv}
                  data-price-van={service.price.van}
                >
                  <span class="font-medium text-gray-900 group-hover:text-primary">{service.label}</span>
                  <span class="service-price text-primary font-bold">¬£{service.price.car}</span>
                </button>
              ))}
            </div>
          </div>

          <!-- Step 3: Name -->
          <div class="booking-step hidden" data-step="3">
            <h3 class="text-2xl font-heading font-bold text-gray-900 text-center mb-6">
              What's your name?
            </h3>
            <input
              type="text"
              id="booking-name"
              placeholder="Enter your full name"
              class="w-full px-6 py-4 text-lg border-2 border-gray-200 rounded-xl focus:border-primary focus:outline-none transition-colors"
              autocomplete="name"
            />
            <button type="button" id="name-next" class="w-full mt-6 bg-primary text-white py-4 rounded-full font-medium hover:bg-secondary transition-colors">
              Continue
            </button>
          </div>

          <!-- Step 4: Email -->
          <div class="booking-step hidden" data-step="4">
            <h3 class="text-2xl font-heading font-bold text-gray-900 text-center mb-6">
              What's your email?
            </h3>
            <input
              type="email"
              id="booking-email"
              placeholder="your@email.com"
              class="w-full px-6 py-4 text-lg border-2 border-gray-200 rounded-xl focus:border-primary focus:outline-none transition-colors"
              autocomplete="email"
            />
            <p class="text-sm text-gray-500 mt-2 text-center">We'll send your booking confirmation here</p>
            <button type="button" id="email-next" class="w-full mt-6 bg-primary text-white py-4 rounded-full font-medium hover:bg-secondary transition-colors">
              Continue
            </button>
          </div>

          <!-- Step 5: Phone -->
          <div class="booking-step hidden" data-step="5">
            <h3 class="text-2xl font-heading font-bold text-gray-900 text-center mb-6">
              Your phone number?
            </h3>
            <input
              type="tel"
              id="booking-phone"
              placeholder="07XXX XXXXXX"
              class="w-full px-6 py-4 text-lg border-2 border-gray-200 rounded-xl focus:border-primary focus:outline-none transition-colors"
              autocomplete="tel"
            />
            <p class="text-sm text-gray-500 mt-2 text-center">So we can confirm your appointment</p>
            <button type="button" id="phone-next" class="w-full mt-6 bg-primary text-white py-4 rounded-full font-medium hover:bg-secondary transition-colors">
              Continue
            </button>
          </div>

          <!-- Step 6: Date -->
          <div class="booking-step hidden" data-step="6">
            <h3 class="text-2xl font-heading font-bold text-gray-900 text-center mb-6">
              Preferred date?
            </h3>
            <input
              type="date"
              id="booking-date"
              class="w-full px-6 py-4 text-lg border-2 border-gray-200 rounded-xl focus:border-primary focus:outline-none transition-colors"
            />
            <p class="text-sm text-gray-500 mt-2 text-center">We're open 9am - 7pm, 7 days a week</p>
            <button type="button" id="submit-booking" class="w-full mt-6 bg-primary text-white py-4 rounded-full font-medium hover:bg-secondary transition-colors flex items-center justify-center gap-2">
              <span>Request Appointment</span>
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3" />
              </svg>
            </button>
          </div>

          <!-- Loading State -->
          <div class="booking-step hidden" data-step="loading">
            <div class="text-center py-12">
              <div class="w-16 h-16 border-4 border-primary border-t-transparent rounded-full animate-spin mx-auto mb-6"></div>
              <p class="text-gray-600">Sending your request...</p>
            </div>
          </div>

          <!-- Success State -->
          <div class="booking-step hidden" data-step="success">
            <div class="text-center py-8">
              <div class="w-20 h-20 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-6">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 text-green-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                </svg>
              </div>
              <h3 class="text-2xl font-heading font-bold text-gray-900 mb-4">Request Sent!</h3>
              <p class="text-gray-600 mb-6">We've received your booking request and sent a confirmation to your email.</p>

              <!-- Important Notice -->
              <div class="bg-amber-50 border-2 border-amber-200 rounded-xl p-4 mb-6">
                <div class="flex items-start gap-3">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-amber-600 flex-shrink-0 mt-0.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                  </svg>
                  <div class="text-left">
                    <p class="font-semibold text-amber-800">Your appointment is NOT confirmed yet</p>
                    <p class="text-sm text-amber-700 mt-1">A member of our team will call or text you shortly to confirm your booking.</p>
                  </div>
                </div>
              </div>

              <button type="button" id="booking-done" class="bg-primary text-white px-8 py-3 rounded-full font-medium hover:bg-secondary transition-colors">
                Got it!
              </button>
            </div>
          </div>

          <!-- Error State -->
          <div class="booking-step hidden" data-step="error">
            <div class="text-center py-8">
              <div class="w-20 h-20 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-6">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 text-red-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
              </div>
              <h3 class="text-2xl font-heading font-bold text-gray-900 mb-4">Something went wrong</h3>
              <p class="text-gray-600 mb-6">Please try again or call us directly at <a href="tel:07977889747" class="text-primary font-medium">07 977 889747</a></p>
              <button type="button" id="booking-retry" class="bg-primary text-white px-8 py-3 rounded-full font-medium hover:bg-secondary transition-colors">
                Try Again
              </button>
            </div>
          </div>

        </div>

        <!-- Back Button -->
        <button type="button" id="booking-back" class="hidden mt-4 text-gray-500 hover:text-gray-700 text-sm flex items-center gap-1 mx-auto">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
          </svg>
          Back
        </button>
      </div>
    </div>
  </div>
</div>

<script>
  // Booking Form Logic
  const modal = document.getElementById('booking-modal');
  const backdrop = document.getElementById('booking-backdrop');
  const closeBtn = document.getElementById('booking-close');
  const backBtn = document.getElementById('booking-back');
  const progressBar = document.getElementById('progress-bar');
  const stepIndicator = document.getElementById('step-indicator');
  const steps = document.querySelectorAll('.booking-step');

  let currentStep = 1;
  const totalSteps = 6;

  // Form data
  const formData: Record<string, string> = {
    vehicle: '',
    vehicleLabel: '',
    service: '',
    serviceLabel: '',
    price: '',
    name: '',
    email: '',
    phone: '',
    date: ''
  };

  // Open modal
  function openBookingModal() {
    modal?.classList.remove('hidden');
    document.body.style.overflow = 'hidden';
    currentStep = 1;
    updateStep();
  }

  // Close modal
  function closeBookingModal() {
    modal?.classList.add('hidden');
    document.body.style.overflow = '';
    // Reset form
    currentStep = 1;
    Object.keys(formData).forEach(key => formData[key] = '');
    document.querySelectorAll('.vehicle-option, .service-option').forEach(el => {
      el.classList.remove('border-primary', 'bg-primary/10');
    });
    (document.getElementById('booking-name') as HTMLInputElement).value = '';
    (document.getElementById('booking-email') as HTMLInputElement).value = '';
    (document.getElementById('booking-phone') as HTMLInputElement).value = '';
    (document.getElementById('booking-date') as HTMLInputElement).value = '';
    updateStep();
  }

  // Update visible step
  function updateStep() {
    steps.forEach(step => {
      const stepNum = step.getAttribute('data-step');
      if (stepNum === currentStep.toString() || stepNum === 'loading' || stepNum === 'success' || stepNum === 'error') {
        step.classList.toggle('hidden', stepNum !== currentStep.toString());
      } else {
        step.classList.add('hidden');
      }
    });

    // Update progress
    const progress = (currentStep / totalSteps) * 100;
    if (progressBar) progressBar.style.width = `${Math.min(progress, 100)}%`;
    if (stepIndicator) stepIndicator.textContent = `Step ${currentStep} of ${totalSteps}`;

    // Show/hide back button
    if (backBtn) {
      backBtn.classList.toggle('hidden', currentStep <= 1);
    }

    // Update service prices based on vehicle type
    if (currentStep === 2 && formData.vehicle) {
      document.querySelectorAll('.service-option').forEach(el => {
        const priceEl = el.querySelector('.service-price');
        const price = el.getAttribute(`data-price-${formData.vehicle}`);
        if (priceEl && price) priceEl.textContent = `¬£${price}`;
      });
    }
  }

  function showStep(step: string) {
    steps.forEach(s => s.classList.add('hidden'));
    const targetStep = document.querySelector(`.booking-step[data-step="${step}"]`);
    if (targetStep) targetStep.classList.remove('hidden');
  }

  // Next step
  function nextStep() {
    if (currentStep < totalSteps) {
      currentStep++;
      updateStep();
    }
  }

  // Previous step
  function prevStep() {
    if (currentStep > 1) {
      currentStep--;
      updateStep();
    }
  }

  // Event Listeners
  backdrop?.addEventListener('click', closeBookingModal);
  closeBtn?.addEventListener('click', closeBookingModal);
  backBtn?.addEventListener('click', prevStep);

  // Vehicle selection
  document.querySelectorAll('.vehicle-option').forEach(btn => {
    btn.addEventListener('click', () => {
      document.querySelectorAll('.vehicle-option').forEach(el => {
        el.classList.remove('border-primary', 'bg-primary/10');
      });
      btn.classList.add('border-primary', 'bg-primary/10');
      formData.vehicle = btn.getAttribute('data-vehicle') || '';
      formData.vehicleLabel = btn.querySelector('span:last-child')?.textContent || '';
      setTimeout(nextStep, 200);
    });
  });

  // Service selection
  document.querySelectorAll('.service-option').forEach(btn => {
    btn.addEventListener('click', () => {
      document.querySelectorAll('.service-option').forEach(el => {
        el.classList.remove('border-primary', 'bg-primary/10');
      });
      btn.classList.add('border-primary', 'bg-primary/10');
      formData.service = btn.getAttribute('data-service') || '';
      formData.serviceLabel = btn.getAttribute('data-service-label') || '';
      formData.price = btn.querySelector('.service-price')?.textContent || '';
      setTimeout(nextStep, 200);
    });
  });

  // Name input
  document.getElementById('name-next')?.addEventListener('click', () => {
    const input = document.getElementById('booking-name') as HTMLInputElement;
    if (input.value.trim()) {
      formData.name = input.value.trim();
      nextStep();
    } else {
      input.focus();
      input.classList.add('border-red-400');
      setTimeout(() => input.classList.remove('border-red-400'), 1000);
    }
  });

  // Email input
  document.getElementById('email-next')?.addEventListener('click', () => {
    const input = document.getElementById('booking-email') as HTMLInputElement;
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    if (emailRegex.test(input.value.trim())) {
      formData.email = input.value.trim();
      nextStep();
    } else {
      input.focus();
      input.classList.add('border-red-400');
      setTimeout(() => input.classList.remove('border-red-400'), 1000);
    }
  });

  // Phone input
  document.getElementById('phone-next')?.addEventListener('click', () => {
    const input = document.getElementById('booking-phone') as HTMLInputElement;
    if (input.value.trim().length >= 10) {
      formData.phone = input.value.trim();
      nextStep();
    } else {
      input.focus();
      input.classList.add('border-red-400');
      setTimeout(() => input.classList.remove('border-red-400'), 1000);
    }
  });

  // Set min date to today
  const dateInput = document.getElementById('booking-date') as HTMLInputElement;
  if (dateInput) {
    const today = new Date().toISOString().split('T')[0];
    dateInput.min = today;
    dateInput.value = today;
  }

  // Submit booking
  document.getElementById('submit-booking')?.addEventListener('click', async () => {
    const input = document.getElementById('booking-date') as HTMLInputElement;
    if (!input.value) {
      input.focus();
      input.classList.add('border-red-400');
      setTimeout(() => input.classList.remove('border-red-400'), 1000);
      return;
    }
    formData.date = input.value;

    // Show loading
    showStep('loading');

    try {
      const response = await fetch('/api/booking', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(formData)
      });

      if (response.ok) {
        showStep('success');
      } else {
        showStep('error');
      }
    } catch (error) {
      showStep('error');
    }
  });

  // Done button
  document.getElementById('booking-done')?.addEventListener('click', closeBookingModal);

  // Retry button
  document.getElementById('booking-retry')?.addEventListener('click', () => {
    currentStep = 1;
    updateStep();
  });

  // Enter key navigation
  ['booking-name', 'booking-email', 'booking-phone'].forEach(id => {
    document.getElementById(id)?.addEventListener('keydown', (e) => {
      if ((e as KeyboardEvent).key === 'Enter') {
        e.preventDefault();
        document.getElementById(`${id.replace('booking-', '')}-next`)?.click();
      }
    });
  });

  // Expose openBookingModal globally
  (window as any).openBookingModal = openBookingModal;
</script>
